---
export const prerender = true;
import { getCollection } from "astro:content";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PlaceCard from "../../../components/PlaceCard.astro";
import seoDescriptions from "../../../data/seo-descriptions.json";

function slugify(str: string) {
  return str.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
}

export async function getStaticPaths() {
  const _slugify = (s: string) => s.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
  const allPlaces = await getCollection("places");

  /* Group by city → category */
  const combos = new Map<string, { cityName: string; category: string; region: string; places: typeof allPlaces }>();

  for (const p of allPlaces) {
    const city = p.data.city;
    if (!/^[A-Za-z]/.test(city) || city.length <= 2) continue;
    const key = `${city}::${p.data.category}`;
    if (!combos.has(key)) {
      combos.set(key, {
        cityName: city,
        category: p.data.category,
        region: p.data.region,
        places: [],
      });
    }
    combos.get(key)!.places.push(p);
  }

  return [...combos.values()].map(({ cityName, category, region, places }) => ({
    params: {
      city: _slugify(cityName),
      category: _slugify(category),
    },
    props: { cityName, category, region, places },
  }));
}

const { cityName, category, region, places } = Astro.props;

const sorted = [...places].sort(
  (a, b) => (b.data.ratings.google_rating ?? 0) - (a.data.ratings.google_rating ?? 0),
);

const bestPlace = sorted[0];
const title = `Best ${category} in ${cityName} — Northeast Explorer`;
const nicheKey = `${slugify(cityName)}/${slugify(category)}`;
const seoDescription = seoDescriptions.nicheIntersects[nicheKey] || "";
const description = seoDescription || `Discover the ${places.length} best ${category.toLowerCase()} destinations in ${cityName}, ${region}. Ratings, entry fees, how to reach, and travel tips.`;

/* ── Schema.org FAQPage JSON-LD ────────────────────────────────────── */
const freeCount = places.filter(
  (p) => p.data.entry_fees.indian_inr.toLowerCase().includes("free"),
).length;

const bestMonths = bestPlace?.data.seasonality.best_months.slice(0, 3).join(", ") ?? "October–March";

const faqItems = [
  {
    q: `What is the best ${category} in ${cityName}?`,
    a: bestPlace
      ? `${bestPlace.data.name} is the highest-rated ${category.toLowerCase()} in ${cityName} with a Google rating of ${bestPlace.data.ratings.google_rating ?? "N/A"}.`
      : `There are ${places.length} ${category.toLowerCase()} destinations in ${cityName} worth visiting.`,
  },
  {
    q: `How many ${category.toLowerCase()} places are in ${cityName}?`,
    a: `There are ${places.length} ${category.toLowerCase()} destinations in ${cityName}, ${region}.`,
  },
  {
    q: `Are ${category.toLowerCase()} in ${cityName} free to visit?`,
    a: freeCount > 0
      ? `Yes, ${freeCount} out of ${places.length} ${category.toLowerCase()} places in ${cityName} have free entry.`
      : `Most ${category.toLowerCase()} places in ${cityName} charge an entry fee. Check individual listings for details.`,
  },
  {
    q: `What is the best time to visit ${category.toLowerCase()} in ${cityName}?`,
    a: `The best months to visit ${category.toLowerCase()} in ${cityName} are ${bestMonths}. Avoid monsoon season (June–September) for the best experience.`,
  },
];

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  mainEntity: faqItems.map((f) => ({
    "@type": "Question",
    name: f.q,
    acceptedAnswer: {
      "@type": "Answer",
      text: f.a,
    },
  })),
};
---

<BaseLayout title={title} description={description}>

  {/* JSON-LD in head */}
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  {/* ═══ Hero ════════════════════════════════════════════════════════ */}
  <section class="relative overflow-hidden bg-gray-900 py-20 sm:py-28">
    {/* Background image */}
    {bestPlace?.data.images[0] && (
      <img
        src={bestPlace.data.images[0]}
        alt={`${category} in ${cityName}`}
        class="absolute inset-0 h-full w-full object-cover opacity-30"
      />
    )}
    <div class="absolute inset-0 bg-gradient-to-r from-gray-900/95 to-gray-900/60" />

    <div class="relative mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <nav class="mb-8 flex items-center gap-2 text-sm text-gray-400">
        <a href="/" class="hover:text-white">Home</a>
        <span>/</span>
        <a href={`/destinations/${slugify(cityName)}`} class="hover:text-white">{cityName}</a>
        <span>/</span>
        <span class="text-white">{category}</span>
      </nav>

      <span class="inline-block rounded-full bg-emerald-500/20 px-4 py-1.5 text-sm font-semibold text-emerald-300 ring-1 ring-inset ring-emerald-500/30">
        {places.length} {places.length === 1 ? "destination" : "destinations"}
      </span>

      <h1 class="mt-4 text-4xl font-bold tracking-tight text-white sm:text-5xl lg:text-6xl">
        Best {category} in {cityName}
      </h1>

      <p class="mt-4 max-w-2xl text-lg text-gray-300">
        Explore the top {category.toLowerCase()} destinations in {cityName}, {region}.
        Curated with ratings, entry fees, and travel details.
      </p>

      {seoDescription && (
        <p class="mt-4 max-w-2xl text-base leading-relaxed text-gray-400">
          {seoDescription}
        </p>
      )}
    </div>
  </section>

  {/* ═══ Results grid ════════════════════════════════════════════════ */}
  <section class="bg-gray-50 py-16">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">

      {/* Featured #1 — Large card */}
      {bestPlace && (
        <a
          href={`/places/${bestPlace.data.id}`}
          class="group mb-10 grid overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm transition hover:shadow-lg sm:grid-cols-2"
        >
          <div class="aspect-4/3 overflow-hidden bg-gray-100 sm:aspect-auto sm:min-h-[320px]">
            {bestPlace.data.images[0] ? (
              <img
                src={bestPlace.data.images[0]}
                alt={bestPlace.data.name}
                class="h-full w-full object-cover transition duration-500 group-hover:scale-105"
              />
            ) : (
              <div class="flex h-full w-full items-center justify-center bg-gradient-to-br from-emerald-50 to-emerald-100">
                <svg class="h-16 w-16 text-emerald-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.41a2.25 2.25 0 013.182 0l2.909 2.91" />
                </svg>
              </div>
            )}
          </div>

          <div class="flex flex-col justify-center p-8 sm:p-10">
            <span class="mb-3 w-fit rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700">
              #1 Highest Rated
            </span>
            <h2 class="text-2xl font-bold text-gray-900 group-hover:text-emerald-700 sm:text-3xl">
              {bestPlace.data.name}
            </h2>
            <p class="mt-2 text-gray-500">
              {bestPlace.data.sub_category} &middot; {bestPlace.data.location.state}
            </p>

            {bestPlace.data.ratings.google_rating && (
              <div class="mt-4 flex items-center gap-3">
                <span class="flex items-center gap-1 text-lg font-bold text-amber-500">
                  &#9733; {bestPlace.data.ratings.google_rating}
                </span>
                {bestPlace.data.ratings.google_reviews_count && (
                  <span class="text-sm text-gray-400">
                    {bestPlace.data.ratings.google_reviews_count} reviews
                  </span>
                )}
              </div>
            )}

            <p class="mt-4 text-sm text-gray-500">
              Entry: {bestPlace.data.entry_fees.indian_inr || "Contact for details"}
            </p>

            <div class="mt-6 flex flex-wrap gap-2">
              {bestPlace.data.tags.slice(0, 4).map((tag) => (
                <span class="rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-600">
                  {tag}
                </span>
              ))}
            </div>
          </div>
        </a>
      )}

      {/* Rest of places */}
      {sorted.length > 1 && (
        <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
          {sorted.slice(1).map((place) => (
            <PlaceCard
              id={place.data.id}
              name={place.data.name}
              category={place.data.category}
              subCategory={place.data.sub_category}
              state={place.data.location.state}
              googleRating={place.data.ratings.google_rating}
              reviewsCount={place.data.ratings.google_reviews_count}
              tags={place.data.tags}
              image={place.data.images[0]}
              logistics={place.data.logistics}
            />
          ))}
        </div>
      )}
    </div>
  </section>

  {/* ═══ FAQ Section (visible + JSON-LD) ═════════════════════════════ */}
  <section class="bg-white py-16">
    <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-gray-900">
        Frequently Asked Questions
      </h2>
      <p class="mt-2 mb-8 text-gray-500">
        Common questions about {category.toLowerCase()} in {cityName}.
      </p>

      <div class="divide-y divide-gray-200">
        {faqItems.map((faq) => (
          <details class="group py-5">
            <summary class="flex cursor-pointer items-center justify-between text-left font-semibold text-gray-900 group-open:text-emerald-700">
              {faq.q}
              <svg class="ml-4 h-5 w-5 flex-shrink-0 text-gray-400 transition group-open:rotate-180 group-open:text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <p class="mt-3 text-gray-600 leading-relaxed">
              {faq.a}
            </p>
          </details>
        ))}
      </div>
    </div>
  </section>

  {/* ═══ Back to city hub ════════════════════════════════════════════ */}
  <div class="bg-gray-50 py-8">
    <div class="mx-auto max-w-7xl px-4 text-center sm:px-6 lg:px-8">
      <a
        href={`/destinations/${slugify(cityName)}`}
        class="inline-flex items-center gap-2 text-sm font-semibold text-emerald-600 hover:text-emerald-700"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        All places in {cityName}
      </a>
    </div>
  </div>

</BaseLayout>
